name: ğŸš€ Publish Gittxt Release & Publish to PyPI

on:
  push:
    tags:
      - "v*"  # Triggers when a new Git tag like "v1.0.0" is pushed

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: ğŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“ Read README for release notes
        id: readme
        run: echo "::set-output name=notes::$(sed ':a;N;$!ba;s/\n/%0A/g' README.md)"

      - name: ğŸ— Build Distribution (Poetry)
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry build

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: "${{ steps.readme.outputs.notes }}"
          draft: false
          prerelease: false
          files: "dist/*"  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    name: ğŸ“¦ Publish to PyPI
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python & Poetry
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: ğŸ“¦ Install Poetry
        run: pip install poetry

      - name: ğŸ— Build Distribution (Ensure Files Exist)
        run: poetry build  

      - name: ğŸ“¦ Publish to PyPI
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_API_TOKEN }}
        run: poetry publish --username __token__ --password $POETRY_PYPI_TOKEN_PYPI

